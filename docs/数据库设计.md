# 数据库设计文档

## 概述

本文档详细描述了中文版年龄主题内容分享网站的数据库设计，包括表结构、索引、约束、存储过程等。

## 数据库选择

**数据库类型**：PostgreSQL（通过Supabase托管）
**选择理由**：
- 开源免费，功能强大
- 支持JSON数据类型
- 优秀的全文搜索功能
- Supabase提供实时订阅功能
- 内置Row Level Security

## 表结构设计

### 1. 用户表 (users)

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  username VARCHAR(50) UNIQUE NOT NULL,
  email VARCHAR(255) UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  avatar_url TEXT,
  bio TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_login_at TIMESTAMP WITH TIME ZONE,
  is_active BOOLEAN DEFAULT true,
  is_verified BOOLEAN DEFAULT false,
  
  -- 约束
  CONSTRAINT username_length CHECK (length(username) >= 3 AND length(username) <= 50),
  CONSTRAINT username_format CHECK (username ~ '^[a-zA-Z0-9_\u4e00-\u9fa5]+$'),
  CONSTRAINT email_format CHECK (email ~ '^[^@]+@[^@]+\.[^@]+$')
);

-- 注释
COMMENT ON TABLE users IS '用户表';
COMMENT ON COLUMN users.username IS '用户名，唯一标识';
COMMENT ON COLUMN users.email IS '邮箱地址，可选';
COMMENT ON COLUMN users.password_hash IS '密码哈希值';
COMMENT ON COLUMN users.avatar_url IS '头像URL';
COMMENT ON COLUMN users.bio IS '个人简介';
COMMENT ON COLUMN users.is_verified IS '邮箱是否已验证';
```

### 2. 年龄内容表 (age_posts)

```sql
CREATE TABLE age_posts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  target_age INTEGER NOT NULL,
  content TEXT NOT NULL,
  author_age INTEGER NOT NULL,
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  username VARCHAR(50), -- 冗余存储，防止用户删除后丢失
  like_count INTEGER DEFAULT 0,
  view_count INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  is_active BOOLEAN DEFAULT true,
  is_featured BOOLEAN DEFAULT false, -- 是否精选
  
  -- 约束
  CONSTRAINT target_age_range CHECK (target_age >= 7 AND target_age <= 91),
  CONSTRAINT author_age_range CHECK (author_age >= 7 AND author_age <= 91),
  CONSTRAINT content_length CHECK (length(content) > 0 AND length(content) <= 1000),
  CONSTRAINT like_count_positive CHECK (like_count >= 0),
  CONSTRAINT view_count_positive CHECK (view_count >= 0)
);

-- 注释
COMMENT ON TABLE age_posts IS '年龄内容表';
COMMENT ON COLUMN age_posts.target_age IS '目标年龄（建议给几岁的人）';
COMMENT ON COLUMN age_posts.content IS '建议内容';
COMMENT ON COLUMN age_posts.author_age IS '作者年龄';
COMMENT ON COLUMN age_posts.user_id IS '用户ID，匿名发布时为NULL';
COMMENT ON COLUMN age_posts.username IS '用户名冗余存储';
COMMENT ON COLUMN age_posts.like_count IS '点赞数量';
COMMENT ON COLUMN age_posts.view_count IS '浏览次数';
COMMENT ON COLUMN age_posts.is_featured IS '是否为精选内容';
```

### 3. 点赞记录表 (post_likes)

```sql
CREATE TABLE post_likes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID NOT NULL REFERENCES age_posts(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- 唯一约束（防重复点赞）
  CONSTRAINT unique_user_like UNIQUE(post_id, user_id),
  CONSTRAINT unique_anonymous_like UNIQUE(post_id, ip_address, user_agent),
  
  -- 检查约束（确保有用户ID或IP地址）
  CONSTRAINT like_identity_check CHECK (
    (user_id IS NOT NULL) OR (ip_address IS NOT NULL AND user_agent IS NOT NULL)
  )
);

-- 注释
COMMENT ON TABLE post_likes IS '点赞记录表';
COMMENT ON COLUMN post_likes.post_id IS '内容ID';
COMMENT ON COLUMN post_likes.user_id IS '用户ID（登录用户）';
COMMENT ON COLUMN post_likes.ip_address IS 'IP地址（匿名用户）';
COMMENT ON COLUMN post_likes.user_agent IS '浏览器标识（匿名用户）';
```

### 4. 用户会话表 (user_sessions)

```sql
CREATE TABLE user_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  session_token VARCHAR(255) UNIQUE NOT NULL,
  refresh_token VARCHAR(255),
  expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_accessed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  ip_address INET,
  user_agent TEXT,
  
  -- 约束
  CONSTRAINT expires_future CHECK (expires_at > created_at)
);

-- 注释
COMMENT ON TABLE user_sessions IS '用户会话表';
COMMENT ON COLUMN user_sessions.session_token IS '会话令牌';
COMMENT ON COLUMN user_sessions.refresh_token IS '刷新令牌';
COMMENT ON COLUMN user_sessions.expires_at IS '过期时间';
COMMENT ON COLUMN user_sessions.last_accessed_at IS '最后访问时间';
```

### 5. 内容浏览记录表 (post_views)

```sql
CREATE TABLE post_views (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID NOT NULL REFERENCES age_posts(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  ip_address INET,
  user_agent TEXT,
  viewed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  
  -- 防重复浏览（同一用户/IP在短时间内的重复浏览）
  CONSTRAINT unique_user_view UNIQUE(post_id, user_id, DATE(viewed_at)),
  CONSTRAINT unique_anonymous_view UNIQUE(post_id, ip_address, DATE(viewed_at))
);

-- 注释
COMMENT ON TABLE post_views IS '内容浏览记录表';
COMMENT ON COLUMN post_views.viewed_at IS '浏览时间';
```

## 索引设计

### 主要索引

```sql
-- 年龄内容表索引
CREATE INDEX idx_age_posts_target_age ON age_posts(target_age);
CREATE INDEX idx_age_posts_like_count ON age_posts(like_count DESC);
CREATE INDEX idx_age_posts_created_at ON age_posts(created_at DESC);
CREATE INDEX idx_age_posts_user_id ON age_posts(user_id);
CREATE INDEX idx_age_posts_active ON age_posts(is_active);

-- 复合索引（优化排序查询）
CREATE INDEX idx_age_posts_target_age_likes ON age_posts(target_age, like_count DESC, created_at DESC) 
WHERE is_active = true;

CREATE INDEX idx_age_posts_featured ON age_posts(is_featured, like_count DESC) 
WHERE is_active = true;

-- 点赞记录表索引
CREATE INDEX idx_post_likes_post_id ON post_likes(post_id);
CREATE INDEX idx_post_likes_user_id ON post_likes(user_id);
CREATE INDEX idx_post_likes_created_at ON post_likes(created_at);

-- 用户表索引
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at);
CREATE INDEX idx_users_active ON users(is_active);

-- 会话表索引
CREATE INDEX idx_user_sessions_token ON user_sessions(session_token);
CREATE INDEX idx_user_sessions_user_id ON user_sessions(user_id);
CREATE INDEX idx_user_sessions_expires ON user_sessions(expires_at);

-- 浏览记录表索引
CREATE INDEX idx_post_views_post_id ON post_views(post_id);
CREATE INDEX idx_post_views_viewed_at ON post_views(viewed_at);
```

### 全文搜索索引

```sql
-- 为内容搜索创建全文索引
CREATE INDEX idx_age_posts_content_search ON age_posts 
USING gin(to_tsvector('chinese', content)) 
WHERE is_active = true;

-- 为用户名搜索创建索引
CREATE INDEX idx_users_username_search ON users 
USING gin(to_tsvector('chinese', username)) 
WHERE is_active = true;
```

## 存储过程和函数

### 1. 点赞计数更新函数

```sql
-- 增加点赞计数
CREATE OR REPLACE FUNCTION increment_like_count(post_id UUID)
RETURNS void AS $$
BEGIN
  UPDATE age_posts 
  SET like_count = like_count + 1, updated_at = NOW()
  WHERE id = post_id AND is_active = true;
END;
$$ LANGUAGE plpgsql;

-- 减少点赞计数
CREATE OR REPLACE FUNCTION decrement_like_count(post_id UUID)
RETURNS void AS $$
BEGIN
  UPDATE age_posts 
  SET like_count = GREATEST(like_count - 1, 0), updated_at = NOW()
  WHERE id = post_id AND is_active = true;
END;
$$ LANGUAGE plpgsql;
```

### 2. 浏览计数更新函数

```sql
CREATE OR REPLACE FUNCTION increment_view_count(post_id UUID)
RETURNS void AS $$
BEGIN
  UPDATE age_posts 
  SET view_count = view_count + 1, updated_at = NOW()
  WHERE id = post_id AND is_active = true;
END;
$$ LANGUAGE plpgsql;
```

### 3. 获取年龄统计函数

```sql
CREATE OR REPLACE FUNCTION get_age_post_counts()
RETURNS TABLE(age INTEGER, post_count BIGINT) AS $$
BEGIN
  RETURN QUERY
  SELECT 
    target_age as age,
    COUNT(*) as post_count
  FROM age_posts 
  WHERE is_active = true
  GROUP BY target_age
  ORDER BY target_age;
END;
$$ LANGUAGE plpgsql;
```

## 触发器

### 1. 自动更新时间戳

```sql
-- 通用的更新时间戳函数
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 为各表创建触发器
CREATE TRIGGER update_users_updated_at
  BEFORE UPDATE ON users
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_age_posts_updated_at
  BEFORE UPDATE ON age_posts
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();
```

### 2. 点赞计数同步触发器

```sql
-- 点赞记录插入时更新计数
CREATE OR REPLACE FUNCTION sync_like_count_on_insert()
RETURNS TRIGGER AS $$
BEGIN
  PERFORM increment_like_count(NEW.post_id);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 点赞记录删除时更新计数
CREATE OR REPLACE FUNCTION sync_like_count_on_delete()
RETURNS TRIGGER AS $$
BEGIN
  PERFORM decrement_like_count(OLD.post_id);
  RETURN OLD;
END;
$$ LANGUAGE plpgsql;

-- 创建触发器
CREATE TRIGGER trigger_like_count_insert
  AFTER INSERT ON post_likes
  FOR EACH ROW
  EXECUTE FUNCTION sync_like_count_on_insert();

CREATE TRIGGER trigger_like_count_delete
  AFTER DELETE ON post_likes
  FOR EACH ROW
  EXECUTE FUNCTION sync_like_count_on_delete();
```

## Row Level Security (RLS)

### 用户表安全策略

```sql
-- 启用RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- 用户只能查看自己的完整信息
CREATE POLICY users_select_own ON users
  FOR SELECT USING (auth.uid() = id);

-- 用户只能更新自己的信息
CREATE POLICY users_update_own ON users
  FOR UPDATE USING (auth.uid() = id);
```

### 内容表安全策略

```sql
-- 启用RLS
ALTER TABLE age_posts ENABLE ROW LEVEL SECURITY;

-- 所有人都可以查看活跃的内容
CREATE POLICY age_posts_select_active ON age_posts
  FOR SELECT USING (is_active = true);

-- 用户只能插入自己的内容
CREATE POLICY age_posts_insert_own ON age_posts
  FOR INSERT WITH CHECK (auth.uid() = user_id OR user_id IS NULL);

-- 用户只能更新自己的内容
CREATE POLICY age_posts_update_own ON age_posts
  FOR UPDATE USING (auth.uid() = user_id);
```

## 数据迁移脚本

### 初始化脚本

```sql
-- 创建数据库扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";

-- 插入初始数据
INSERT INTO users (username, email, password_hash, is_verified) VALUES
('admin', 'admin@example.com', '$2b$10$...', true),
('demo_user', 'demo@example.com', '$2b$10$...', true);

-- 插入示例内容
INSERT INTO age_posts (target_age, content, author_age, username) VALUES
(18, '开始健身，现在比以后任何时候都容易', 27, 'demo_user'),
(18, '多陪陪你的祖父母，他们不会永远在你身边', 25, 'demo_user'),
(25, '不要害怕失败，失败教会你人生中真正重要的课程', 35, 'admin');
```

## 性能优化建议

### 1. 查询优化
- 使用复合索引优化常用查询
- 避免SELECT *，只查询需要的字段
- 使用LIMIT限制结果集大小
- 合理使用JOIN，避免N+1查询

### 2. 索引优化
- 定期分析查询计划
- 删除未使用的索引
- 考虑部分索引减少存储空间
- 监控索引使用情况

### 3. 数据清理
- 定期清理过期会话
- 归档旧的浏览记录
- 软删除替代硬删除
- 实施数据保留策略

## 备份和恢复策略

### 1. 自动备份
- Supabase提供自动备份功能
- 每日增量备份
- 每周全量备份
- 备份保留30天

### 2. 手动备份
```bash
# 导出数据库结构
pg_dump --schema-only -h host -U user -d database > schema.sql

# 导出数据
pg_dump --data-only -h host -U user -d database > data.sql

# 完整备份
pg_dump -h host -U user -d database > full_backup.sql
```

### 3. 恢复流程
```bash
# 恢复结构
psql -h host -U user -d database < schema.sql

# 恢复数据
psql -h host -U user -d database < data.sql
```

## 监控和维护

### 1. 性能监控
- 查询执行时间监控
- 索引使用率统计
- 连接数监控
- 磁盘空间使用

### 2. 数据质量监控
- 数据完整性检查
- 约束违反监控
- 异常数据检测
- 数据一致性验证

### 3. 定期维护任务
- 重建索引
- 更新统计信息
- 清理临时数据
- 性能调优

这个数据库设计为网站提供了坚实的数据基础，支持高并发访问、数据安全和性能优化。
