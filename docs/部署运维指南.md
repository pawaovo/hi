# 部署运维指南

## 概述

本文档详细描述了中文版年龄主题内容分享网站的部署流程、运维策略和监控方案。

## 技术架构

### 整体架构图
```
用户 → Cloudflare CDN → Next.js应用 → Supabase数据库
                    ↓
              Supabase Auth（认证服务）
                    ↓
              Supabase Storage（文件存储）
```

### 服务组件
- **前端应用**：Next.js 15 + React 19
- **数据库**：Supabase PostgreSQL
- **认证服务**：Supabase Auth
- **CDN**：Cloudflare Pages
- **监控**：Vercel Analytics + Sentry
- **域名解析**：Cloudflare DNS

## 环境配置

### 开发环境
```bash
# 克隆项目
git clone https://github.com/your-org/age-wisdom-site.git
cd age-wisdom-site

# 安装依赖
npm install

# 配置环境变量
cp .env.example .env.local

# 启动开发服务器
npm run dev
```

### 环境变量配置
```bash
# .env.local (开发环境)
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
NEXT_PUBLIC_SITE_URL=http://localhost:3000

# 可选配置
NEXT_PUBLIC_GOOGLE_ANALYTICS_ID=G-XXXXXXXXXX
SENTRY_DSN=https://your-sentry-dsn
NEXT_PUBLIC_VERCEL_ANALYTICS_ID=your-analytics-id
```

```bash
# .env.production (生产环境)
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
NEXT_PUBLIC_SITE_URL=https://your-domain.com

# 生产环境配置
NEXT_PUBLIC_GOOGLE_ANALYTICS_ID=G-XXXXXXXXXX
SENTRY_DSN=https://your-sentry-dsn
NEXT_PUBLIC_VERCEL_ANALYTICS_ID=your-analytics-id
```

## Supabase配置

### 1. 创建Supabase项目
```bash
# 安装Supabase CLI
npm install -g supabase

# 登录Supabase
supabase login

# 初始化项目
supabase init

# 启动本地开发环境
supabase start
```

### 2. 数据库迁移
```bash
# 创建迁移文件
supabase migration new initial_schema

# 应用迁移
supabase db push

# 重置数据库（开发环境）
supabase db reset
```

### 3. 数据库配置文件
```sql
-- supabase/migrations/20240101000000_initial_schema.sql
-- 在此文件中包含所有表结构、索引、函数等SQL语句
-- 参考 docs/数据库设计.md 中的完整SQL脚本
```

### 4. Row Level Security配置
```sql
-- supabase/migrations/20240101000001_rls_policies.sql
-- 启用RLS并创建安全策略
-- 参考 docs/数据库设计.md 中的RLS配置
```

## Cloudflare Pages部署

### 1. 项目配置
```toml
# wrangler.toml
name = "age-wisdom-site"
compatibility_date = "2024-01-01"

[build]
command = "npm run build"
cwd = "."

[env.production]
NEXT_PUBLIC_SUPABASE_URL = "https://your-project.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY = "your-anon-key"
NEXT_PUBLIC_SITE_URL = "https://your-domain.com"
```

### 2. 构建配置
```json
// package.json
{
  "scripts": {
    "build": "next build",
    "build:analyze": "ANALYZE=true next build",
    "start": "next start",
    "lint": "next lint",
    "type-check": "tsc --noEmit"
  }
}
```

### 3. Next.js配置
```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'export',
  trailingSlash: true,
  images: {
    unoptimized: true
  },
  env: {
    NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,
    NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
  },
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-XSS-Protection',
            value: '1; mode=block',
          },
          {
            key: 'Referrer-Policy',
            value: 'origin-when-cross-origin',
          },
        ],
      },
    ]
  },
}

module.exports = nextConfig
```

### 4. 部署流程
```bash
# 1. 连接到Cloudflare Pages
npx wrangler pages project create age-wisdom-site

# 2. 部署到生产环境
npm run build
npx wrangler pages deploy dist

# 3. 设置自定义域名
npx wrangler pages domain add your-domain.com
```

## CI/CD配置

### 1. GitHub Actions工作流
```yaml
# .github/workflows/deploy.yml
name: Deploy to Cloudflare Pages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - run: npm ci
      - run: npm run lint
      - run: npm run type-check
      - run: npm run test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - run: npm ci
      - run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: age-wisdom-site
          directory: dist
```

### 2. 预发布环境
```yaml
# .github/workflows/staging.yml
name: Deploy to Staging

on:
  push:
    branches: [develop]

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - run: npm ci
      - run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.STAGING_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.STAGING_SUPABASE_ANON_KEY }}
      
      - name: Deploy to Staging
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: age-wisdom-site-staging
          directory: dist
```

## 监控和日志

### 1. 错误监控 (Sentry)
```typescript
// lib/sentry.ts
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 1.0,
  beforeSend(event) {
    // 过滤敏感信息
    if (event.user) {
      delete event.user.email
    }
    return event
  }
})
```

### 2. 性能监控 (Vercel Analytics)
```typescript
// app/layout.tsx
import { Analytics } from '@vercel/analytics/react'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html>
      <body>
        {children}
        <Analytics />
      </body>
    </html>
  )
}
```

### 3. 自定义监控
```typescript
// lib/monitoring.ts
export class Monitor {
  static trackEvent(event: string, properties?: Record<string, any>) {
    // 发送到分析服务
    if (typeof window !== 'undefined' && window.gtag) {
      window.gtag('event', event, properties)
    }
  }

  static trackError(error: Error, context?: Record<string, any>) {
    console.error('Application Error:', error, context)
    
    // 发送到Sentry
    Sentry.captureException(error, {
      tags: context,
    })
  }

  static trackPerformance(metric: string, value: number) {
    // 性能指标监控
    if (typeof window !== 'undefined' && window.gtag) {
      window.gtag('event', 'timing_complete', {
        name: metric,
        value: Math.round(value),
      })
    }
  }
}
```

## 备份策略

### 1. 数据库备份
```bash
# 自动备份脚本
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups"
DB_NAME="your-database"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 导出数据库
pg_dump $DATABASE_URL > $BACKUP_DIR/backup_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/backup_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +7 -delete

echo "Backup completed: backup_$DATE.sql.gz"
```

### 2. 代码备份
```bash
# Git备份策略
git remote add backup https://github.com/your-org/age-wisdom-site-backup.git
git push backup main
```

### 3. 配置备份
```bash
# 备份环境变量和配置
cp .env.production .env.backup.$(date +%Y%m%d)
cp wrangler.toml wrangler.backup.$(date +%Y%m%d)
```

## 安全配置

### 1. 环境变量安全
- 使用GitHub Secrets存储敏感信息
- 定期轮换API密钥
- 最小权限原则

### 2. 网络安全
```javascript
// next.config.js 安全头配置
const securityHeaders = [
  {
    key: 'X-DNS-Prefetch-Control',
    value: 'on'
  },
  {
    key: 'Strict-Transport-Security',
    value: 'max-age=63072000; includeSubDomains; preload'
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff'
  },
  {
    key: 'X-Frame-Options',
    value: 'DENY'
  },
  {
    key: 'X-XSS-Protection',
    value: '1; mode=block'
  },
  {
    key: 'Referrer-Policy',
    value: 'origin-when-cross-origin'
  },
  {
    key: 'Content-Security-Policy',
    value: "default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
  }
]
```

### 3. 数据库安全
- 启用Row Level Security (RLS)
- 定期更新依赖包
- 监控异常访问

## 性能优化

### 1. CDN配置
```javascript
// Cloudflare缓存规则
const cacheRules = {
  '*.js': 'max-age=31536000',
  '*.css': 'max-age=31536000',
  '*.png': 'max-age=31536000',
  '*.jpg': 'max-age=31536000',
  '/api/*': 'max-age=300',
  '/': 'max-age=3600'
}
```

### 2. 数据库优化
```sql
-- 定期维护任务
VACUUM ANALYZE;
REINDEX DATABASE your_database;

-- 监控慢查询
SELECT query, mean_time, calls 
FROM pg_stat_statements 
ORDER BY mean_time DESC 
LIMIT 10;
```

### 3. 应用优化
- 启用gzip压缩
- 图片懒加载
- 代码分割
- 预加载关键资源

## 故障处理

### 1. 常见问题排查
```bash
# 检查应用状态
curl -I https://your-domain.com

# 检查数据库连接
psql $DATABASE_URL -c "SELECT 1"

# 检查日志
tail -f /var/log/application.log
```

### 2. 回滚策略
```bash
# 快速回滚到上一个版本
git revert HEAD
git push origin main

# 数据库回滚
psql $DATABASE_URL < backup_20240101_120000.sql
```

### 3. 应急联系方式
- 技术负责人：your-email@domain.com
- 运维团队：ops@domain.com
- 紧急电话：+86-xxx-xxxx-xxxx

这个部署运维指南为网站的稳定运行提供了完整的保障体系。
