# 前端架构设计文档

## 概述

本文档详细描述了中文版年龄主题内容分享网站的前端架构设计，包括技术栈选择、组件架构、状态管理、路由设计等。

## 技术栈

### 核心框架
- **Next.js 15**：React全栈框架，支持SSR/SSG
- **React 19**：最新版本，支持并发特性
- **TypeScript**：类型安全，提升开发效率

### UI框架
- **Tailwind CSS**：原子化CSS框架
- **Shadcn/ui**：基于Radix UI的组件库
- **Lucide React**：图标库

### 状态管理
- **Zustand**：轻量级状态管理
- **React Query (TanStack Query)**：服务器状态管理
- **React Hook Form**：表单状态管理

### 工具库
- **Supabase Client**：数据库和认证客户端
- **Date-fns**：日期处理
- **Zod**：数据验证

## 项目结构

```
src/
├── app/                      # Next.js 13+ App Router
│   ├── (auth)/              # 认证相关页面组
│   │   ├── login/
│   │   └── register/
│   ├── age/                 # 年龄页面
│   │   └── [age]/
│   ├── profile/             # 用户中心
│   ├── globals.css          # 全局样式
│   ├── layout.tsx           # 根布局
│   └── page.tsx             # 首页
├── components/              # 组件目录
│   ├── ui/                  # 基础UI组件
│   ├── layout/              # 布局组件
│   ├── auth/                # 认证组件
│   ├── age/                 # 年龄相关组件
│   ├── posts/               # 内容相关组件
│   └── common/              # 通用组件
├── hooks/                   # 自定义Hooks
├── lib/                     # 工具库
├── stores/                  # 状态管理
├── types/                   # TypeScript类型
└── utils/                   # 工具函数
```

## 组件架构

### 1. 布局组件 (Layout Components)

#### RootLayout
```typescript
// app/layout.tsx
import { Inter } from 'next/font/google'
import { Providers } from '@/components/providers'
import { Header } from '@/components/layout/header'
import { Footer } from '@/components/layout/footer'

const inter = Inter({ subsets: ['latin'] })

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="zh-CN">
      <body className={inter.className}>
        <Providers>
          <div className="min-h-screen flex flex-col">
            <Header />
            <main className="flex-1">
              {children}
            </main>
            <Footer />
          </div>
        </Providers>
      </body>
    </html>
  )
}
```

#### Header组件
```typescript
// components/layout/header.tsx
import Link from 'next/link'
import { Button } from '@/components/ui/button'
import { UserMenu } from '@/components/auth/user-menu'
import { useAuth } from '@/hooks/use-auth'

export function Header() {
  const { user, isLoading } = useAuth()

  return (
    <header className="border-b bg-white">
      <div className="container mx-auto px-4 h-16 flex items-center justify-between">
        <Link href="/" className="text-xl font-bold">
          年龄智慧
        </Link>
        
        <nav className="hidden md:flex items-center space-x-6">
          <Link href="/age" className="text-gray-600 hover:text-gray-900">
            浏览建议
          </Link>
          <Link href="/about" className="text-gray-600 hover:text-gray-900">
            关于我们
          </Link>
        </nav>

        <div className="flex items-center space-x-4">
          {isLoading ? (
            <div className="w-8 h-8 animate-pulse bg-gray-200 rounded-full" />
          ) : user ? (
            <UserMenu user={user} />
          ) : (
            <div className="flex items-center space-x-2">
              <Button variant="ghost" asChild>
                <Link href="/login">登录</Link>
              </Button>
              <Button asChild>
                <Link href="/register">注册</Link>
              </Button>
            </div>
          )}
        </div>
      </div>
    </header>
  )
}
```

### 2. 年龄相关组件 (Age Components)

#### AgeGrid组件
```typescript
// components/age/age-grid.tsx
import { AgeCard } from './age-card'
import { useAgeCounts } from '@/hooks/use-age-counts'
import { Skeleton } from '@/components/ui/skeleton'

export function AgeGrid() {
  const { data: ageCounts, isLoading } = useAgeCounts()

  const ages = Array.from({ length: 85 }, (_, i) => i + 7) // 7-91岁

  if (isLoading) {
    return (
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {ages.map((age) => (
          <Skeleton key={age} className="h-32" />
        ))}
      </div>
    )
  }

  return (
    <div className="space-y-8">
      <div className="text-center">
        <h1 className="text-3xl font-bold text-gray-900 mb-4">
          选择你的年龄
        </h1>
        <p className="text-gray-600 max-w-2xl mx-auto">
          查看来自不同年龄段的人生建议和智慧分享，
          或者为特定年龄的人分享你的经验。
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {ages.map((age) => (
          <AgeCard
            key={age}
            age={age}
            postCount={ageCounts?.[age] || 0}
          />
        ))}
      </div>
    </div>
  )
}
```

#### AgeCard组件
```typescript
// components/age/age-card.tsx
import Link from 'next/link'
import { Card, CardContent } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'

interface AgeCardProps {
  age: number
  postCount: number
}

export function AgeCard({ age, postCount }: AgeCardProps) {
  return (
    <Link href={`/age/${age}`}>
      <Card className="hover:shadow-lg transition-all duration-200 cursor-pointer group">
        <CardContent className="p-6 relative">
          <div className="text-center">
            <div className="text-4xl font-bold text-primary mb-2 group-hover:scale-110 transition-transform">
              {age}岁
            </div>
            <div className="text-sm text-gray-500">
              {postCount > 0 ? `${postCount} 条建议` : '暂无建议'}
            </div>
          </div>
          
          {postCount > 0 && (
            <Badge 
              variant="secondary" 
              className="absolute top-2 right-2"
            >
              {postCount}
            </Badge>
          )}
        </CardContent>
      </Card>
    </Link>
  )
}
```

### 3. 内容相关组件 (Post Components)

#### PostForm组件
```typescript
// components/posts/post-form.tsx
import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'
import { Button } from '@/components/ui/button'
import { Textarea } from '@/components/ui/textarea'
import { AgeSelector } from './age-selector'
import { useAuth } from '@/hooks/use-auth'
import { useCreatePost } from '@/hooks/use-posts'
import { LoginModal } from '@/components/auth/login-modal'

const postSchema = z.object({
  content: z.string()
    .min(1, '请输入建议内容')
    .max(1000, '内容不能超过1000字'),
  authorAge: z.number()
    .min(7, '年龄不能小于7岁')
    .max(91, '年龄不能大于91岁')
})

type PostFormData = z.infer<typeof postSchema>

interface PostFormProps {
  targetAge: number
  onSuccess?: () => void
}

export function PostForm({ targetAge, onSuccess }: PostFormProps) {
  const [showLoginModal, setShowLoginModal] = useState(false)
  const { user, isAuthenticated } = useAuth()
  const createPost = useCreatePost()

  const form = useForm<PostFormData>({
    resolver: zodResolver(postSchema),
    defaultValues: {
      content: '',
      authorAge: undefined
    }
  })

  const onSubmit = async (data: PostFormData) => {
    if (!isAuthenticated) {
      setShowLoginModal(true)
      return
    }

    try {
      await createPost.mutateAsync({
        target_age: targetAge,
        content: data.content,
        author_age: data.authorAge,
        user_id: user?.id,
        username: user?.username
      })
      
      form.reset()
      onSuccess?.()
    } catch (error) {
      console.error('发布失败:', error)
    }
  }

  const handleAnonymousPost = async () => {
    const data = form.getValues()
    
    try {
      await createPost.mutateAsync({
        target_age: targetAge,
        content: data.content,
        author_age: data.authorAge
      })
      
      form.reset()
      setShowLoginModal(false)
      onSuccess?.()
    } catch (error) {
      console.error('发布失败:', error)
    }
  }

  return (
    <>
      <Card className="mb-8">
        <CardHeader>
          <CardTitle>给 {targetAge} 岁的建议</CardTitle>
        </CardHeader>
        <CardContent>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            <div>
              <Textarea
                placeholder="分享你的人生建议..."
                {...form.register('content')}
                className="min-h-[120px]"
              />
              {form.formState.errors.content && (
                <p className="text-sm text-red-500 mt-1">
                  {form.formState.errors.content.message}
                </p>
              )}
            </div>

            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-4">
                <AgeSelector
                  value={form.watch('authorAge')}
                  onChange={(age) => form.setValue('authorAge', age)}
                  placeholder="选择你的年龄"
                />
                {form.formState.errors.authorAge && (
                  <p className="text-sm text-red-500">
                    {form.formState.errors.authorAge.message}
                  </p>
                )}
              </div>

              <div className="flex items-center space-x-2">
                <span className="text-sm text-gray-500">
                  {form.watch('content')?.length || 0}/1000
                </span>
                <Button 
                  type="submit" 
                  disabled={createPost.isPending}
                >
                  {createPost.isPending ? '发布中...' : '发布'}
                </Button>
              </div>
            </div>
          </form>
        </CardContent>
      </Card>

      <LoginModal
        open={showLoginModal}
        onClose={() => setShowLoginModal(false)}
        onAnonymousPost={handleAnonymousPost}
        canAnonymousPost={form.formState.isValid}
      />
    </>
  )
}
```

#### PostList组件
```typescript
// components/posts/post-list.tsx
import { PostCard } from './post-card'
import { Skeleton } from '@/components/ui/skeleton'
import { usePosts } from '@/hooks/use-posts'

interface PostListProps {
  targetAge: number
}

export function PostList({ targetAge }: PostListProps) {
  const { 
    data, 
    isLoading, 
    fetchNextPage, 
    hasNextPage, 
    isFetchingNextPage 
  } = usePosts(targetAge)

  if (isLoading) {
    return (
      <div className="space-y-4">
        {Array.from({ length: 5 }).map((_, i) => (
          <Skeleton key={i} className="h-32" />
        ))}
      </div>
    )
  }

  const posts = data?.pages.flatMap(page => page.posts) || []

  if (posts.length === 0) {
    return (
      <div className="text-center py-12">
        <p className="text-gray-500 text-lg">
          还没有人给 {targetAge} 岁的人分享建议
        </p>
        <p className="text-gray-400 mt-2">
          成为第一个分享智慧的人吧！
        </p>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {posts.map((post) => (
        <PostCard key={post.id} post={post} />
      ))}

      {hasNextPage && (
        <div className="text-center">
          <Button
            variant="outline"
            onClick={() => fetchNextPage()}
            disabled={isFetchingNextPage}
          >
            {isFetchingNextPage ? '加载中...' : '加载更多'}
          </Button>
        </div>
      )}
    </div>
  )
}
```

## 状态管理

### 1. 认证状态 (Zustand)

```typescript
// stores/auth-store.ts
import { create } from 'zustand'
import { User } from '@/types'

interface AuthState {
  user: User | null
  isLoading: boolean
  setUser: (user: User | null) => void
  setLoading: (loading: boolean) => void
  logout: () => void
}

export const useAuthStore = create<AuthState>((set) => ({
  user: null,
  isLoading: true,
  setUser: (user) => set({ user }),
  setLoading: (isLoading) => set({ isLoading }),
  logout: () => set({ user: null })
}))
```

### 2. 自定义Hooks

```typescript
// hooks/use-auth.ts
import { useEffect } from 'react'
import { useAuthStore } from '@/stores/auth-store'
import { supabase } from '@/lib/supabase'

export function useAuth() {
  const { user, isLoading, setUser, setLoading } = useAuthStore()

  useEffect(() => {
    // 获取当前用户
    supabase.auth.getUser().then(({ data: { user } }) => {
      setUser(user)
      setLoading(false)
    })

    // 监听认证状态变化
    const { data: { subscription } } = supabase.auth.onAuthStateChange(
      (event, session) => {
        setUser(session?.user ?? null)
        setLoading(false)
      }
    )

    return () => subscription.unsubscribe()
  }, [setUser, setLoading])

  return {
    user,
    isLoading,
    isAuthenticated: !!user
  }
}
```

```typescript
// hooks/use-posts.ts
import { useInfiniteQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { supabase } from '@/lib/supabase'
import { AgePost } from '@/types'

export function usePosts(targetAge: number) {
  return useInfiniteQuery({
    queryKey: ['posts', targetAge],
    queryFn: async ({ pageParam = 0 }) => {
      const { data, error, count } = await supabase
        .from('age_posts')
        .select('*', { count: 'exact' })
        .eq('target_age', targetAge)
        .eq('is_active', true)
        .order('like_count', { ascending: false })
        .order('created_at', { ascending: false })
        .range(pageParam * 20, (pageParam + 1) * 20 - 1)

      if (error) throw error

      return {
        posts: data || [],
        nextPage: data && data.length === 20 ? pageParam + 1 : undefined,
        totalCount: count || 0
      }
    },
    getNextPageParam: (lastPage) => lastPage.nextPage,
    initialPageParam: 0
  })
}

export function useCreatePost() {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (post: Omit<AgePost, 'id' | 'created_at' | 'updated_at' | 'like_count'>) => {
      const { data, error } = await supabase
        .from('age_posts')
        .insert(post)
        .select()
        .single()

      if (error) throw error
      return data
    },
    onSuccess: (data) => {
      // 更新相关查询缓存
      queryClient.invalidateQueries({ queryKey: ['posts', data.target_age] })
      queryClient.invalidateQueries({ queryKey: ['age-counts'] })
    }
  })
}
```

## 路由设计

### App Router结构

```
app/
├── layout.tsx               # 根布局
├── page.tsx                 # 首页 (/)
├── (auth)/                  # 认证路由组
│   ├── login/
│   │   └── page.tsx         # 登录页 (/login)
│   └── register/
│       └── page.tsx         # 注册页 (/register)
├── age/
│   ├── page.tsx             # 年龄列表 (/age)
│   └── [age]/
│       └── page.tsx         # 年龄详情 (/age/18)
├── profile/
│   ├── page.tsx             # 个人中心 (/profile)
│   └── posts/
│       └── page.tsx         # 我的发布 (/profile/posts)
├── about/
│   └── page.tsx             # 关于页面 (/about)
└── api/                     # API路由
    ├── auth/
    ├── posts/
    └── likes/
```

## 性能优化

### 1. 代码分割
- 使用动态导入延迟加载组件
- 路由级别的代码分割
- 第三方库按需加载

### 2. 图片优化
- Next.js Image组件自动优化
- WebP格式支持
- 响应式图片

### 3. 缓存策略
- React Query缓存服务器状态
- 浏览器缓存静态资源
- CDN缓存优化

### 4. 渲染优化
- 使用React.memo防止不必要的重渲染
- useMemo和useCallback优化计算
- 虚拟滚动处理大列表

## 响应式设计

### 断点设计
```css
/* Tailwind CSS 断点 */
sm: 640px   /* 小屏幕 */
md: 768px   /* 中等屏幕 */
lg: 1024px  /* 大屏幕 */
xl: 1280px  /* 超大屏幕 */
2xl: 1536px /* 超超大屏幕 */
```

### 移动端适配
- 触摸友好的交互设计
- 合适的点击区域大小
- 移动端导航优化
- 安全区域适配

## 可访问性

### ARIA支持
- 语义化HTML标签
- ARIA标签和属性
- 键盘导航支持
- 屏幕阅读器友好

### 颜色和对比度
- 符合WCAG 2.1标准
- 高对比度模式支持
- 色盲友好的设计

## 测试策略

### 1. 单元测试
```typescript
// __tests__/components/age-card.test.tsx
import { render, screen } from '@testing-library/react'
import { AgeCard } from '@/components/age/age-card'

describe('AgeCard', () => {
  it('renders age and post count correctly', () => {
    render(<AgeCard age={18} postCount={5} />)

    expect(screen.getByText('18岁')).toBeInTheDocument()
    expect(screen.getByText('5 条建议')).toBeInTheDocument()
  })

  it('shows "暂无建议" when post count is 0', () => {
    render(<AgeCard age={25} postCount={0} />)

    expect(screen.getByText('暂无建议')).toBeInTheDocument()
  })
})
```

### 2. 集成测试
```typescript
// __tests__/pages/age.test.tsx
import { render, screen, waitFor } from '@testing-library/react'
import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
import AgePage from '@/app/age/[age]/page'

const createTestQueryClient = () => new QueryClient({
  defaultOptions: {
    queries: { retry: false },
    mutations: { retry: false }
  }
})

describe('Age Page', () => {
  it('loads and displays posts for specific age', async () => {
    const queryClient = createTestQueryClient()

    render(
      <QueryClientProvider client={queryClient}>
        <AgePage params={{ age: '18' }} />
      </QueryClientProvider>
    )

    await waitFor(() => {
      expect(screen.getByText('嗨 18岁')).toBeInTheDocument()
    })
  })
})
```

### 3. E2E测试
```typescript
// e2e/age-flow.spec.ts
import { test, expect } from '@playwright/test'

test('user can browse age-specific advice', async ({ page }) => {
  await page.goto('/')

  // 点击18岁年龄卡片
  await page.click('text=18岁')

  // 验证页面标题
  await expect(page.locator('h1')).toContainText('嗨 18岁')

  // 验证建议列表加载
  await expect(page.locator('[data-testid=post-card]')).toBeVisible()
})
```

## 部署配置

### 1. Vercel部署
```json
// vercel.json
{
  "framework": "nextjs",
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "env": {
    "NEXT_PUBLIC_SUPABASE_URL": "@supabase-url",
    "NEXT_PUBLIC_SUPABASE_ANON_KEY": "@supabase-anon-key"
  }
}
```

### 2. Cloudflare Pages部署
```toml
# wrangler.toml
name = "age-wisdom-site"
compatibility_date = "2024-01-01"

[build]
command = "npm run build"
cwd = "."

[[env.production.vars]]
NEXT_PUBLIC_SUPABASE_URL = "your-supabase-url"
NEXT_PUBLIC_SUPABASE_ANON_KEY = "your-supabase-anon-key"
```

### 3. 环境变量配置
```bash
# .env.local
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
NEXTAUTH_SECRET=your-nextauth-secret
NEXTAUTH_URL=http://localhost:3000
```

这个前端架构设计为网站提供了现代化、可维护、高性能的用户界面基础。
